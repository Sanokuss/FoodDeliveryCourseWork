@model CheckoutViewModel
@{
    ViewData["Title"] = "–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è";
}

@section Styles {
    <link rel="stylesheet" href="~/css/order.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <style>
        .highlight-success {
            animation: highlightPulse 1s ease-out;
            background-color: #d4edda !important;
        }
        @@keyframes highlightPulse {
            0% { background-color: #f8f9fa; transform: scale(1); }
            50% { background-color: #d4edda; transform: scale(1.02); }
            100% { background-color: #d4edda; transform: scale(1); }
        }
        .loading-promo {
            background-image: url('data:image/svg+xml,...'); /* Simplify or use border-color change */
            opacity: 0.7;
        }
    </style>
}

<div class="checkout-container">
    <div class="checkout-card fade-up">
        <div class="checkout-header">
            <h1>‚ú® –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>
            <p>–©–µ —Ç—Ä–æ—à–∫–∏, —ñ —Å–º–∞–∫–æ—Ç–∞ –±—É–¥–µ —É –≤–∞—Å! üçï</p>
        </div>

        <form asp-action="PlaceOrder" method="post" class="checkout-form">
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                        <div>
                            <strong>–•–∞–ª–µ–ø–∞!</strong> –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ:
                        </div>
                    </div>
                    <div asp-validation-summary="All" class="mt-2 mb-0 small"></div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div class="form-group floating-group">
                <input asp-for="CustomerName" class="form-control floating-input" placeholder=" " required />
                <label asp-for="CustomerName" class="floating-label">–í–∞—à–µ –Ü–º'—è</label>
                <div class="input-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <span asp-validation-for="CustomerName" class="text-danger small"></span>
            </div>

            <div class="form-group floating-group mt-4">
                <input asp-for="CustomerPhone" class="form-control floating-input" placeholder=" " type="tel" required />
                <label asp-for="CustomerPhone" class="floating-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <div class="input-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </div>
                <small class="text-muted ps-3 start-hint">–§–æ—Ä–º–∞—Ç: +380...</small>
                <span asp-validation-for="CustomerPhone" class="text-danger small"></span>
            </div>

            <div class="form-group floating-group mt-4">
                <textarea asp-for="CustomerAddress" class="form-control floating-input address-input" placeholder=" " rows="3" required></textarea>
                <label asp-for="CustomerAddress" class="floating-label">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                <div class="input-icon top-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                </div>
                <span asp-validation-for="CustomerAddress" class="text-danger small"></span>
            </div>
            <!-- Personal Loyalty Discount Toggle -->
            @if (Model.LoyaltyDiscountPercent > 0)
            {
                <div class="loyalty-discount-card mt-4 p-3 rounded" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 2px solid #ff9800;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="fw-bold" style="color: #e65100;">üéÅ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –∑–Ω–∏–∂–∫–∞</span>
                            <span class="badge bg-success ms-2">@Model.LoyaltyDiscountPercent%</span>
                        </div>
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" asp-for="UsePersonalDiscount" id="loyaltyToggle" style="width: 3rem; height: 1.5rem;">
                            <label class="form-check-label" for="loyaltyToggle"></label>
                        </div>
                    </div>
                    <div class="small text-muted mb-2">
                        –í–∞—à—ñ –ø–æ–∫—É–ø–∫–∏: <strong>@Model.UserTotalSpent.ToString("N0") ‚Ç¥</strong>
                        <span class="ms-2">(1% –∑–∞ –∫–æ–∂–Ω—É 1000 ‚Ç¥, –º–∞–∫—Å. 10%)</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: @(Model.LoyaltyDiscountPercent * 10)%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mt-1">
                        <span>0%</span>
                        <span>10%</span>
                    </div>
                </div>
            }

            <!-- Manual Promo Code -->
             <div class="form-group floating-group mt-4">
                <input asp-for="ManualPromoCode" class="form-control floating-input" placeholder=" " style="text-transform: uppercase;" />
                <label asp-for="ManualPromoCode" class="floating-label">–Ñ –ø—Ä–æ–º–æ–∫–æ–¥?</label>
                <div class="input-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary mt-4 p-3 rounded" style="background-color: #f8f9fa;" id="orderSummary">
                @{
                    var originalTotal = Model.TotalAmount + Model.DiscountAmount;
                    var showDiscount = Model.UsePersonalDiscount && Model.LoyaltyDiscountPercent > 0;
                }
                <div class="d-flex justify-content-between text-muted small" id="originalPriceRow" style="@(showDiscount ? "text-decoration: line-through;" : "display: none;")">
                    <span>–°—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
                    <span id="originalPrice">@originalTotal.ToString("0.00") ‚Ç¥</span>
                </div>
                <div class="d-flex justify-content-between text-success fw-bold my-1" id="discountRow" style="@(showDiscount ? "" : "display: none;")">
                    <span>–ó–Ω–∏–∂–∫–∞ (<span id="discountLabel">@Model.LoyaltyDiscountPercent%</span>):</span>
                    <span id="discountAmount">-@Model.LoyaltyDiscountAmount.ToString("0.00") ‚Ç¥</span>
                </div>
                <hr class="my-2" id="summaryDivider" style="@(showDiscount ? "" : "display: none;")" />
                <div class="d-flex justify-content-between fs-4 fw-bold" style="color: var(--primary-color);">
                    <span>–î–æ —Å–ø–ª–∞—Ç–∏:</span>
                    <span id="finalTotal">@Model.TotalAmount.ToString("0.00") ‚Ç¥</span>
                </div>
            </div>

            <!-- Payment Method Selection -->
            <div class="payment-methods mt-4 mb-4">
                <label class="form-label mb-3 fw-bold">–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏:</label>
                <div class="d-flex gap-3">
                    <label class="payment-option">
                        <input type="radio" asp-for="PaymentMethod" value="Card" checked>
                        <span class="payment-card">
                            <span class="icon">üí≥</span>
                            <span class="title">–ö–∞—Ä—Ç–æ—é</span>
                            <span class="subtitle">Stripe Secure</span>
                        </span>
                    </label>
                    
                    <label class="payment-option">
                        <input type="radio" asp-for="PaymentMethod" value="Cash">
                        <span class="payment-card">
                            <span class="icon">üíµ</span>
                            <span class="title">–ì–æ—Ç—ñ–≤–∫–æ—é</span>
                            <span class="subtitle">–ü—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ</span>
                        </span>
                    </label>
                </div>
                <span asp-validation-for="PaymentMethod" class="text-danger small"></span>
            </div>

            <div class="checkout-actions">
                <button type="submit" class="btn btn-primary btn-lg btn-pay">
                    –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚ú®
                </button>
                <a asp-controller="Cart" asp-action="Index" class="btn btn-outline-secondary btn-back">
                    –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –∫–æ—à–∏–∫–∞
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/js/checkout.js" asp-append-version="true"></script>
    <script>
        (function() {
            const toggle = document.getElementById('loyaltyToggle');
            if (!toggle) return;

            // cartTotal is the ORIGINAL total before any discount
            const cartTotal = @((Model.TotalAmount + Model.LoyaltyDiscountAmount).ToString(System.Globalization.CultureInfo.InvariantCulture));
            const discountAmount = @(Model.LoyaltyDiscountAmount.ToString(System.Globalization.CultureInfo.InvariantCulture));
            const discountPercent = @Model.LoyaltyDiscountPercent;

            function updateSummary() {
                const useDiscount = toggle.checked;
                const originalPriceRow = document.getElementById('originalPriceRow');
                const discountRow = document.getElementById('discountRow');
                const summaryDivider = document.getElementById('summaryDivider');
                const finalTotal = document.getElementById('finalTotal');

                if (useDiscount && discountPercent > 0) {
                    // Show discount UI
                    originalPriceRow.style.display = '';
                    originalPriceRow.style.textDecoration = 'line-through';
                    discountRow.style.display = '';
                    summaryDivider.style.display = '';
                    finalTotal.textContent = (cartTotal - discountAmount).toFixed(2) + ' ‚Ç¥';
                } else {
                    // Hide discount UI, show full price
                    originalPriceRow.style.display = 'none';
                    discountRow.style.display = 'none';
                    summaryDivider.style.display = 'none';
                    finalTotal.textContent = cartTotal.toFixed(2) + ' ‚Ç¥';
                }
            }

            toggle.addEventListener('change', updateSummary);
        })();
    </script>
}

