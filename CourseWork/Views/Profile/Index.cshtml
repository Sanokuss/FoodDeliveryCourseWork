@using CourseWork.Models
@{
    ViewData["Title"] = "–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç";
    var user = ViewBag.User as ApplicationUser;
    var orders = ViewBag.Orders as List<Order>;
    var promotions = ViewBag.Promotions as List<Promotion>;
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
}

<div class="container profile-container">
    <!-- Header Card -->
    <div class="profile-header">
        <div class="profile-avatar">
            <span class="avatar-initials">@(user?.FullName?.Substring(0, 1).ToUpper() ?? "U")</span>
        </div>
        <div class="profile-info">
            <h1>@(user?.FullName ?? "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á")</h1>
            <p class="profile-email">@user?.Email</p>
            
            @if (User.IsInRole("Admin"))
            {
                <span class="badge bg-danger mb-2">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</span>
            }
            else if (User.IsInRole("Manager"))
            {
                <span class="badge bg-primary mb-2">–ú–µ–Ω–µ–¥–∂–µ—Ä</span>
            }

            @if (!string.IsNullOrEmpty(user?.PhoneNumber))
            {
                <p class="profile-details mb-1"><small>üìû @user.PhoneNumber</small></p>
            }
            
            @if (!string.IsNullOrEmpty(user?.Address))
            {
                <p class="profile-details mb-2"><small>üìç @user.Address</small></p>
            }

            <div class="profile-level">
                <span class="level-badge level-@ViewBag.UserLevel.ToLower()">@ViewBag.UserLevel</span>
                @if (ViewBag.DiscountPercent > 0)
                {
                    <span class="discount-badge">-@ViewBag.DiscountPercent% –Ω–∞ –≤—Å—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>
                }
            </div>
            <a asp-action="Edit" class="btn-edit-profile mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                </div>
                <button class="info-btn" onclick="showInfo('orders')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>
            </div>
            <div class="stat-content">
                <span class="stat-value">@ViewBag.OrderCount</span>
                <span class="stat-label">–ó–∞–º–æ–≤–ª–µ–Ω—å</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon spent">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                </div>
                <button class="info-btn" onclick="showInfo('spent')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>
            </div>
            <div class="stat-content">
                <span class="stat-value">@(((decimal)ViewBag.TotalSpent).ToString("N0")) ‚Ç¥</span>
                <span class="stat-label">–í–∏—Ç—Ä–∞—á–µ–Ω–æ</span>
            </div>
        </div>
        <div class="stat-card">
             <div class="stat-header">
                <div class="stat-icon discount">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                </div>
                <button class="info-btn" onclick="showInfo('discount')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>
            </div>
            <div class="stat-content">
                <span class="stat-value">@ViewBag.DiscountPercent%</span>
                <span class="stat-label">–í–∞—à–∞ –∑–Ω–∏–∂–∫–∞</span>
            </div>
        </div>
    </div>

    <!-- Orders Section -->
    <div class="profile-section">
        <h2 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            –Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω—å
        </h2>
        
        @if (orders != null && orders.Any())
        {
            <div class="orders-list">
                @foreach (var order in orders.Take(5))
                {
                    <div class="order-card">
                        <div class="order-header">
                            <span class="order-id">#@order.Id</span>
                            <span class="order-date">@order.OrderDate.ToString("dd MMM yyyy, HH:mm")</span>
                        </div>
                        <div class="order-body">
                            <div class="order-info">
                                <span class="order-address">@order.CustomerAddress</span>
                            </div>
                            <div class="order-total">@order.TotalAmount.ToString("N0") ‚Ç¥</div>
                        </div>
                        <div class="order-footer">
                            <span class="order-status status-@order.OrderStatus.ToLower()">@order.OrderStatus</span>
                        </div>
                    </div>
                }
            </div>
            
            @if (orders.Count > 5)
            {
                <a href="#" class="btn-view-all">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Üí</a>
            }
        }
        else
        {
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                <p>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å</p>
                <a asp-controller="Home" asp-action="Index" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –º–µ–Ω—é</a>
            </div>
        }
    </div>

    <!-- Promotions Section -->
    @if (promotions != null && promotions.Any())
    {
        <div class="profile-section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                –î–æ—Å—Ç—É–ø–Ω—ñ –∞–∫—Ü—ñ—ó
            </h2>
            <div class="promotions-grid">
                @foreach (var promo in promotions)
                {
                    <div class="promo-card">
                        <div class="promo-image">
                            <img src="@promo.ImageUrl" alt="@promo.Title">
                        </div>
                        <div class="promo-content">
                            <h3>@promo.Title</h3>
                            @if (!string.IsNullOrEmpty(promo.PromoCode))
                            {
                                <div class="promo-code">–ö–æ–¥: <strong>@promo.PromoCode</strong></div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Logout Button -->
    <div class="profile-actions">
        <form id="logoutForm" asp-controller="Account" asp-action="Logout" method="post">
            <button type="button" class="btn-logout" onclick="confirmLogout()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                –í–∏–π—Ç–∏ –∑ –∫–∞–±—ñ–Ω–µ—Ç—É
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function confirmLogout() {
            Swal.fire({
                title: '–í–∂–µ –π–¥–µ—Ç–µ?',
                text: "–í–∏ —Ç–æ—á–Ω–æ —Ö–æ—á–µ—Ç–µ –ø—ñ—Ç–∏? –ú–∏ –±—É–¥–µ–º–æ —Å—É–º—É–≤–∞—Ç–∏! ü•∫",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ea7c69',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '–¢–∞–∫, –ø—ñ—Ç–∏',
                cancelButtonText: '–ó–∞–ª–∏—à–∏—Ç–∏—Å—å',
                background: document.body.classList.contains('dark-theme') ? '#1f1d2b' : '#fff',
                color: document.body.classList.contains('dark-theme') ? '#fff' : '#000'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('logoutForm').submit();
                }
            })
        }

        function showInfo(type) {
            let title, text, icon;
            const isDark = document.body.classList.contains('dark-theme');

            switch(type) {
                case 'orders':
                    title = '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω—å';
                    text = '–¶–µ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–∞–∑—ñ–≤, –∫–æ–ª–∏ –º–∏ —Å–º–∞—á–Ω–æ –≤–∞—Å –Ω–∞–≥–æ–¥—É–≤–∞–ª–∏! –ß–∏–º –±—ñ–ª—å—à–µ - —Ç–∏–º –∫—Ä–∞—â–µ! üçî';
                    icon = 'info';
                    break;
                case 'spent':
                    title = '–í–∏—Ç—Ä–∞—á–µ–Ω–æ –∫–æ—à—Ç—ñ–≤';
                    text = '–°—É–º–∞ –≤–∞—à–∏—Ö —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π —É –≤–ª–∞—Å–Ω–µ —â–∞—Å—Ç—è (—ñ —Å–∏—Ç–∏–π —à–ª—É–Ω–æ–∫). –î—è–∫—É—î–º–æ! üí∏';
                    icon = 'success';
                    break;
                case 'discount':
                    title = '–í–∞—à–∞ –∑–Ω–∏–∂–∫–∞';
                    text = '–í–∞—à —Ä—ñ–≤–µ–Ω—å –∫—Ä—É—Ç–æ—Å—Ç—ñ! –ë—ñ–ª—å—à–µ –∑–∞–º–æ–≤–ª–µ–Ω—å -> –±—ñ–ª—å—à–∞ –∑–Ω–∏–∂–∫–∞ -> –±—ñ–ª—å—à–µ –µ–∫–æ–Ω–æ–º—ñ—ó! üìâ';
                    icon = 'star';
                    break;
            }

            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonColor: '#ea7c69',
                confirmButtonText: '–ó—Ä–æ–∑—É–º—ñ–ª–æ!',
                background: isDark ? '#1f1d2b' : '#fff',
                color: isDark ? '#fff' : '#000'
            });
        }
    </script>
}
