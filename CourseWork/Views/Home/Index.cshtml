@model IEnumerable<Product>
@{
    ViewData["Title"] = "Головна";
    var categories = ViewBag.Categories as List<Category>;
}

<div class="container">
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1>Швидка доставка <br><span>Улюблених Страв</span></h1>
            <p>Замовляйте найсмачнішу їжу з найкращих ресторанів міста. Швидка доставка прямо до ваших дверей.</p>
            
            <!-- Search in Hero -->
            <form id="hero-search" asp-action="Index" method="get" style="max-width: 400px; position: relative;">
                <input type="text" name="searchTerm" value="@ViewBag.SearchTerm" placeholder="Що бажаєте з'їсти?" 
                       style="width: 100%; padding: 16px 24px; padding-right: 60px; border-radius: 50px; border: none; background: var(--surface-color); color: var(--text-color); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
                <button type="submit" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; border-radius: 50%; background: var(--primary-color); border: none; color: white; cursor: pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
            </form>
        </div>
        <div class="hero-image-wrapper position-relative">
             <!-- Rotating Pizza Image -->
             <div class="rotating-pizza-container">
                 <img src="~/images/pngwing.com.png" 
                      alt="Delicious Pizza" class="hero-pizza-img">
             </div>
             
             <!-- Text Overlay with Ink Animation -->
             <div class="hero-overlay-text">
                 <svg viewBox="0 0 900 300" width="100%" height="100%" style="overflow: visible;">
                     <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" class="handwritten-text">
                        BodanFood
                     </text>
                 </svg>
             </div>
        </div>
    </section>

    <!-- Categories -->
    <div class="mb-4" id="categories">
        <h3 class="mb-3 text-center" style="font-weight: 700;">Категорії</h3>
        <div class="categories-wrapper justify-content-center">
             <a href="@Url.Action("Index", "Home")#categories" class="category-card @(ViewBag.SelectedCategoryId == null ? "active" : "")" data-category-id="">
                <span class="category-name">Всі</span>
            </a>
            @if (categories != null)
            {
                foreach (var category in categories)
                {
                    <a href="@Url.Action("Index", "Home", new { categoryId = category.Id })#categories" class="category-card @(ViewBag.SelectedCategoryId?.ToString() == category.Id.ToString() ? "active" : "")" data-category-id="@category.Id">
                        <span class="category-name">@category.Name</span>
                    </a>
                }
            }
        </div>
    </div>

    <!-- Products -->
    <div>
        <!-- Sorting Bar (Centered & Styled) -->
        <div class="d-flex justify-content-center justify-content-md-end mb-4 pb-2">
             <form method="get" asp-action="Index" id="sortForm" class="d-flex align-items-center sort-form-container">
                
                <input type="hidden" name="searchTerm" value="@ViewBag.SearchTerm" />
                <input type="hidden" name="categoryId" value="@ViewBag.SelectedCategoryId" />
                
                <label class="sort-label">Сортувати:</label>
                <select name="sortOrder" class="form-select form-select-sm border-0 bg-transparent shadow-none fw-bold sort-select" 
                        onchange="document.getElementById('sortForm').submit()">
                    <!option value="" @(ViewBag.CurrentSort == null ? "selected" : "")>За замовчуванням</!option>
                    <!option value="price_asc" @(ViewBag.CurrentSort == "price_asc" ? "selected" : "")>Від дешевшого до дорожчого</!option>
                    <!option value="price_desc" @(ViewBag.CurrentSort == "price_desc" ? "selected" : "")>Від дорожчого до дешевшого</!option>
                    <!option value="newest" @(ViewBag.CurrentSort == "newest" ? "selected" : "")>Спочатку новинки</!option>
                    <!option value="bestseller" @(ViewBag.CurrentSort == "bestseller" ? "selected" : "")>За популярністю</!option>
                </select>
            </form>
        </div>

        <div id="products-container">
            <partial name="_ProductList" model="Model" />
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ... (Existing Modal Scripts) ...
        function openProductModal(id) {
            // Fetch modal content
            fetch(`@Url.Action("GetProductDetails", "Home")?id=${id}`)
                .then(response => {
                    if (!response.ok) throw new Error("Failed to load");
                    return response.text();
                })
                .then(html => {
                    const container = document.getElementById('modal-container');
                    container.innerHTML = html;
                    
                    // Initialize and show modal
                    const modalElement = document.getElementById('productDetailsModal');
                    
                    // ACCESSIBILITY FIX: Remove aria-hidden before showing, set aria-modal
                    modalElement.removeAttribute('aria-hidden');
                    modalElement.setAttribute('aria-modal', 'true');
                    modalElement.setAttribute('role', 'dialog');

                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    
                    // Handle form submit
                    const form = modalElement.querySelector('form');
                    form.addEventListener('submit', function(e) {
                         // Standard submit
                    });
                })
                .catch(err => console.error(err));
        }

        // Dynamic Price Update
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('qty-btn')) {
                // Allow inline onclick to fire first (stepUp/Down), then update price
                setTimeout(() => updateModalPrice(e.target), 10);
            }
        });

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('qty-input')) {
                updateModalPrice(e.target);
            }
        });

        function updateModalPrice(target) {
            const modal = document.getElementById('productDetailsModal');
            if (!modal) return;
            
            const priceEl = modal.querySelector('#modal-total-price');
            const input = modal.querySelector('input[name="quantity"]');
            
            if (priceEl && input) {
                const basePrice = parseFloat(priceEl.dataset.basePrice);
                const qty = parseInt(input.value);
                if (!isNaN(basePrice) && !isNaN(qty)) {
                    const total = basePrice * qty;
                    priceEl.textContent = total.toFixed(0) + ' ₴';
                }
            }
        }

    </script>
}

